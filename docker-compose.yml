services:
  # Servicio de inicialización - Configura Rclone desde env vars
  init-r2:
    build:
      context: .
      dockerfile: Dockerfile.init-r2
    container_name: vaultwarden-init-r2
    restart: "no"
    environment:
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - RCLONE_REMOTE_NAME=${RCLONE_REMOTE_NAME}
    volumes:
      - vaultwarden-rclone:/root/.config/rclone
    networks:
      - vaultwarden-network

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    depends_on:
      init-r2:
        condition: service_completed_successfully
    environment:
      # Configuración principal
      - DOMAIN=${DOMAIN:-https://vault.example.com}
      - SIGNUPS_ALLOWED=${SIGNUPS_ALLOWED:-false}
      - INVITATIONS_ALLOWED=${INVITATIONS_ALLOWED:-true}
      - SHOW_PASSWORD_HINT=${SHOW_PASSWORD_HINT:-false}
      - WEBSOCKET_ENABLED=true
      - SENDS_ALLOWED=${SENDS_ALLOWED:-true}
      - WEB_VAULT_ENABLED=${WEB_VAULT_ENABLED:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - EXTENDED_LOGGING=${EXTENDED_LOGGING:-true}
      - LOG_FILE=/data/vaultwarden.log
      # Admin Panel
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      # Database (SQLite por defecto)
      - DATABASE_URL=/data/db.sqlite3
      # Cloudflare Zero Trust - IPs de confianza
      - IP_HEADER=CF-Connecting-IP
      - ROCKET_ADDRESS=0.0.0.0
      - ROCKET_PORT=80
      # SMTP (opcional - NO configurar si no lo usas para evitar errores)
      - SMTP_HOST=${SMTP_HOST:-localhost}
      - SMTP_FROM=${SMTP_FROM:-noreply@localhost}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Vaultwarden}
      - SMTP_SECURITY=${SMTP_SECURITY:-starttls}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_TIMEOUT=${SMTP_TIMEOUT:-15}
    volumes:
      - vaultwarden-data:/data
    expose:
      - "80"
    networks:
      - vaultwarden-network
    healthcheck:
      test: ["CMD", "test", "-f", "/data/db.sqlite3"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TZ=${TZ:-America/Mexico_City}
    networks:
      - vaultwarden-network
    depends_on:
      vaultwarden:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8080/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  vaultwarden-backup:
    image: ttionya/vaultwarden-backup:latest
    container_name: vaultwarden-backup
    restart: unless-stopped
    depends_on:
      vaultwarden:
        condition: service_healthy
    environment:
      # Programación
      - CRON=${BACKUP_SCHEDULE:-0 2 * * *}
      - TIMEZONE=${TZ:-America/Mexico_City}
      # Compresión y encriptación
      - ZIP_ENABLE=true
      - ZIP_PASSWORD=${BACKUP_ZIP_PASSWORD}
      - ZIP_TYPE=7z
      - BACKUP_FILE_SUFFIX=%Y%m%d_%H%M%S
      # Cloudflare R2 via Rclone
      - RCLONE_REMOTE_NAME=${RCLONE_REMOTE_NAME:-r2}
      - RCLONE_REMOTE_DIR=${RCLONE_REMOTE_DIR:-/vaultwarden-backups}
      - RCLONE_REMOTE_ENABLE=true
      - RCLONE_CONFIG=/root/.config/rclone/rclone.conf
      # Retención de backups
      - BACKUP_KEEP_DAYS=${BACKUP_KEEP_DAYS:-14}
      # Ping de salud (opcional)
      - PING_URL=${BACKUP_PING_URL}
    volumes:
      - vaultwarden-data:/bitwarden/data:ro
      - vaultwarden-backups:/bitwarden/backup
      - vaultwarden-rclone:/root/.config/rclone
    networks:
      - vaultwarden-network

volumes:
  vaultwarden-data:
    driver: local
  vaultwarden-backups:
    driver: local
  vaultwarden-rclone:
    driver: local

networks:
  vaultwarden-network:
    driver: bridge
